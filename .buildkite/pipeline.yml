env:
  RISC0_RUST_TOOLCHAIN_VERSION: 1.91.1
  RISC0_CPP_TOOLCHAIN_VERSION: 2024.01.05
  RISC0_GROTH16_VERSION: 0.1.0

steps:
  - label: "check"
    agents:
      os: linux
    plugins:
      - .buildkite/plugins/rustup:
    command: .buildkite/steps/check.sh

  - label: ":rust: Clippy {{matrix.os}}/{{matrix.arch}}/{{matrix.feature}}"
    if_changed:
      - .buildkite/**
      - Cargo.toml
      - Cargo.lock
      - rust-toolchain.toml
      - rzup/**
      - risc0/**
    agents:
      arch: "{{matrix.arch}}"
      os: "{{matrix.os}}"
    matrix:
      setup:
        arch: x64
        os: linux
        feature: default
      adjustments:
        - with:
            arch: x64
            os: linux
            feature: cuda
    env:
      FEATURE: "{{matrix.feature}}"
      RISC0_SKIP_BUILD: 1
      RISC0_SKIP_BUILD_KERNELS: 1
    plugins:
      - .buildkite/plugins/cuda:
      - .buildkite/plugins/rustup:
      - .buildkite/plugins/sccache:
      - .buildkite/plugins/protoc:
    command: .buildkite/steps/clippy.sh

  - label: "Test {{matrix.os}}/{{matrix.arch}}/{{matrix.device}}"
    if_changed:
      - .buildkite/**
      - Cargo.toml
      - Cargo.lock
      - rust-toolchain.toml
      - bonsai/sdk/**
      - external/**
      - groth16_proof/**
      - risc0/**
      - rzup/**
      - xtask/**
    agents:
      arch: "{{matrix.arch}}"
      os: "{{matrix.os}}"
      device: "{{matrix.device}}"
    matrix:
      setup:
        arch: x64
        os: linux
        feature: cuda
        device: nvidia_rtx_4000_ada
        nvcc_arch: sm_89
        test_command: cargo nextest run
        partition: 1
        ci_profile: slow
      adjustments:
        - with:
            arch: arm64
            os: macos
            feature: default
            device: apple_m2_pro
            test_command: cargo nextest run --partition hash:1/2
            partition: 1
            ci_profile: fast
          skip: true
        - with:
            arch: arm64
            os: macos
            feature: default
            device: apple_m2_pro
            test_command: cargo nextest run --partition hash:2/2
            partition: 2
            ci_profile: fast
          skip: true
    env:
      FEATURE: "{{matrix.feature}}"
      NVCC_APPEND_FLAGS: "-arch={{matrix.nvcc_arch}}"
      RISC0_DEFAULT_PROVER_NUM_GPUS: 1
      RISC0_BUILD_LOCKED: 1
      RUST_BACKTRACE: full
      RUSTFLAGS: "--cfg ci --cfg ci_profile=\"{{matrix.ci_profile}}\""
      # SCCACHE_RECACHE: 1
      TEST_COMMAND: "{{matrix.test_command}}"
    plugins:
      - .buildkite/plugins/cuda:
      - .buildkite/plugins/rustup:
      - .buildkite/plugins/sccache:
      - .buildkite/plugins/protoc:
    command: .buildkite/steps/test.sh
    artifact_paths:
      - target/cargo-timings/**
