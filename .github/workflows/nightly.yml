name: Nightly Tasks

on:
  schedule:
    - cron: '0 7 * * *' # Nightly (ish) Pacific
  workflow_dispatch:

env:
  RISC0_BUILD_LOCKED: 1
  RISC0_RUST_TOOLCHAIN_VERSION: 1.91.1
  RISC0_CPP_TOOLCHAIN_VERSION: 2024.01.05
  # Pin the nightly Rust version for jobs that need it.
  NIGHTLY_RUST_TOOLCHAIN: nightly-2025-12-15

jobs:
  fuzz:
    runs-on: [self-hosted, cluster, Linux, fuzz]
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - run: git lfs pull
      - uses: ./.github/actions/rustup
        with:
          toolchain: ${{ env.NIGHTLY_RUST_TOOLCHAIN }}
      - uses: baptiste0928/cargo-install@v3
        with:
          crate: cargo-fuzz
          version: "0.13.1"
      - uses: ./.github/actions/sccache
      # Run fuzzing on the two fuzz targets on 8 cores for 1 hour each.
      # Each job takes two corpus dir args. The first is in the home directory, and so persists between runs.
      # The second contains only the checked in corpus files, which provide a seed for coverage.
      # New corpus entries are saved to the first location provided (the home directory).
      - run: cargo "+${NIGHTLY_RUST_TOOLCHAIN}" fuzz run --fuzz-dir risc0/fuzz --sanitizer none -j8 "$FUZZ_TARGET" "$HOME/fuzz/$FUZZ_TARGET/" "./risc0/fuzz/corpus/$FUZZ_TARGET" -- -max_len=1048576 -max_total_time=3600
        env:
          FUZZ_TARGET: receipt_seal_verify
      - run: cargo "+${NIGHTLY_RUST_TOOLCHAIN}" fuzz run --fuzz-dir risc0/fuzz --sanitizer none -j8 "$FUZZ_TARGET" "$HOME/fuzz/$FUZZ_TARGET/" "./risc0/fuzz/corpus/$FUZZ_TARGET" -- -max_len=1048576 -max_total_time=3600
        env:
          FUZZ_TARGET: receipt_decode_and_verify
      - run: sccache --show-stats

  alert_devops_if_failed:
    runs-on: ubuntu-latest
    if: ${{ always() && contains(join(needs.*.result, ','), 'failure') }}
    needs: [fuzz]
    steps:
      - name: DevOps Alert
        env:
          NEEDS: ${{ toJSON(needs) }}
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"Nightly Tasks Job Failed: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}' ${{ secrets.DEVOPS_ALERT_WEBHOOK_URL }}
