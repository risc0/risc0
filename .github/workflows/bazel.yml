name: bazel

on:
  merge_group:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# this is needed to gain access via OIDC to the S3 bucket for caching
permissions:
  id-token: write
  contents: read

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  bazel:
    runs-on: [self-hosted, cluster, "${{ matrix.os }}", "${{ matrix.device }}"]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: Linux
            arch: X64
            feature: cuda
            device: nvidia_rtx_4000_ada
            nvcc_arch: sm_89
          - os: macOS
            arch: ARM64
            feature: default
            device: apple_m2_pro
            #config: --config=ci
    steps:
      - uses: actions/checkout@v3
        with:
          persist-credentials: false
      - run: '(echo machine github.com; echo login x-access-token; echo password $ZIRGEN_TOKEN) > $HOME/.netrc'
        env:
           ZIRGEN_TOKEN: ${{ secrets.GHA_ZIRGEN_TOKEN }}
      - uses: ./.github/actions/bazelisk
      - name: Build & test
        env:
          CONFIG: ${{ matrix.config }}
        run: |
          bazelisk test //... \
              --spawn_strategy=local \
              --test_output=errors \
              --strategy=TestRunner=local \
              --@rules_cuda//cuda:archs=${{ matrix.nvcc_arch }}
        working-directory: risc0/circuit/rv32im-m3-sys/cxx
      - run: 'rm -f $HOME/.netrc'
        continue-on-error: true
